mainModule.controller("adminController",function($scope, $http, $location){
	$scope.pages = [];
	$scope.users = [];
		
	$scope.loadPages = function(){
		
		$http.post("admin/pages/list").
			success(function(res){
				
				if(res.status == 'ok')
					$scope.pages = res.body;
				else 
					alert("Error: " + res.body);
			
			}).
			error(function(res){
				alert("Server not respond.");
			});
		};
		
		$scope.loadUsers = function(){
			
			$http.post("admin/users/list").
				success(function(res){
					
					if(res.status == 'ok'){
						$scope.users = res.body;
						console.log(res.body);
					}
					else 
						alert("Error: " + res.body);
				
				}).
				error(function(res){
					alert("Server not respond.");
				});
			
			
			
		};
	$scope.$on('$routeChangeSuccess', function () {
		
		
		getCurrentUser($http,function(user){
			if(user == undefined || user.role != "ADMIN") $location.path("/login");
			
			
			$scope.username = user.name;
			$scope.email = user.email;
			$scope.loadUsers();
			$scope.loadPages();
			
		});
		
	});
	
	
	
	$scope.setAsAdmin = function(event){
		var userId = event.target.dataset.userId;
		
		$http.post("/admin/user/updateToAdmin/"+ userId).
		success(function(res){
			
			if(res.status == 'ok'){
				alert("Update: done");
				$scope.loadUsers();
			}
			else 
				alert("Error: " + res.body);
		
		}).
		error(function(res){
			alert("Server not respond.");
		});
	};
	
	$scope.setAsClient = function(event){
		var userId = event.target.dataset.userId;
		
		$http.post("/admin/user/updateToClient/"+ userId).
		success(function(res){
			
			if(res.status == 'ok'){
				alert("Update: done");
				$scope.loadUsers();
			}
			else 
				alert("Error: " + res.body);
		
		}).
		error(function(res){
			alert("Server not respond.");
		});
	};
	
	$scope.deletePage = function(event){
		var userId = event.target.dataset.userId;
		
		$http.post("/admin/page/remove/"+ userId).
		success(function(res){
			
			if(res.status == 'ok'){
				alert("Delete: done");
				$scope.loadPages();
			}
			else 
				alert("Error: " + res.body);
		
		}).
		error(function(res){
			alert("Server not respond.");
		});
	};
	
	$scope.changeUserPermission = function(event){
		var userId = event.target.dataset.userId;
		var csp = event.target.dataset.canSeePages == "true";
		
		$http.post("/admin/user/updateCSP/",{
			userId:userId,
			csp: !csp
		}).
		success(function(res){
			
			if(res.status == 'ok'){
				alert("Update: done");
				$scope.loadUsers();
			}
			else 
				alert("Error: " + res.body);
		
		}).
		error(function(res){
			alert("Server not respond.");
		});
		
	};
	
	
	$scope.logoutUser = function(){
		logout($http,$location);
	};
	
});
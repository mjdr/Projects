mainModule.controller("pageEditController",function($scope, $http, $location,$routeParams){
	
	$scope.$on('$routeChangeSuccess', function () {
		getCurrentUser($http,function(user){
			if(user == undefined || user.role != "ADMIN") $location.path("/login");
			$scope.init();
		});
		
	});

	
	$scope.init = function(){
		$scope.pageId = $routeParams.pageId;
		
		if($scope.pageId == "new"){
			$scope.pageId = -1;
			$scope.pageTitle = "New Title";
			$scope.pageSource = "Test";
			$scope.pageVisible = true;
		}
		else
			$scope.loadPageData($scope.pageId);
		
	};
	$scope.loadPageData = function(pageId){
		
		$http.post("/page/data/" + pageId
		).success(function(res){
			if(res.status == 'ok'){
					$scope.pageId = res.body.id;
					$scope.pageTitle = res.body.title;
					$scope.pageSource = res.body.source;
					$scope.pageVisible = res.body.visible;
			}
			else {
				alert("Error: " + res.body);
			}
		}).
		error(function(res){
			alert("Server not respond.");
		});
		
	};
	

	$scope.submit = function(){
		
		var data = {
				id: $scope.pageId,
				title: $scope.pageTitle,
				source: $scope.pageSource,
				visible: $scope.pageVisible
		};
		
		if($scope.pageId == -1)
			$scope.savePage(data);
		else
			$scope.updatePage(data);
	};
	
	$scope.savePage = function(data){
		$http.post("/admin/page/add", data
		).success(function(res){
			if(res.status == 'ok'){
				alert("Page added!");
				$location.path("/admin");
			}
			else 
				alert("Error: " + res.body);
			
		}).
		error(function(res){
			alert("Server not respond.");
		});
	};
	$scope.updatePage = function(data){
		$http.post("/admin/page/update", data
		).success(function(res){
			if(res.status == 'ok'){
				alert("Page updated!");
				$location.path("/admin");
			}
			else 
				alert("Error: " + res.body);
			
		}).
		error(function(res){
			alert("Server not respond.");
		});
	};
});